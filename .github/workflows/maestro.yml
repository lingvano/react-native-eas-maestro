name: CI Actions
on:
  push:
    branches: [master, main]
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true
jobs:
  maestro-ios:
    name: Maestro IOS
    runs-on: ubuntu-latest
    steps:
      - name: 🏗 Checkout repository
        uses: actions/checkout@v2

      - name: 🏗 Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: npm

      - name: 🏗  Setup EAS CLI
        uses: expo/expo-github-action@v7
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      # - name: 🚀  Send build request without submit
      #   run: eas build --platform ios --non-interactive --profile development-sim
      #   shell: bash

      - name: get latest build Android
        id: retrieveUrlAndroid
        run: |
          echo "BUILD_URL_ANDROID=$(node ./scripts/latestBuildAndroid.js)" >> $GITHUB_OUTPUT

      - name: get latest build
        id: retrieveUrlIos
        run: |
          echo "BUILD_URL=$(node ./scripts/latestBuildIos.js)" >> $GITHUB_OUTPUT

      - name: download latest build Android
        id: downloadfileandroid
        uses: suisei-cn/actions-download-file@v1
        with:
          url: ${{ steps.retrieveUrlAndroid.outputs.BUILD_URL_ANDROID }}
          target: bin/

      - name: download latest build
        id: downloadfileios
        uses: suisei-cn/actions-download-file@v1
        with:
          url: ${{ steps.retrieveUrlIos.outputs.BUILD_URL }}
          target: bin/

      - name: unzip latest build
        run: tar -xvf bin/${{ steps.downloadfileios.outputs.filename }}
        shell: bash

      - uses: mobile-dev-inc/action-maestro-cloud@v1.1.1
        with:
          api-key: ${{ secrets.MAESTRO_CLOUD_API_KEY }}
          app-file: bin/Lingvano.app
          workspace: maestro/

      - name: upload to maestro cloud and run test ANDROID
        uses: mobile-dev-inc/action-maestro-cloud@v1.1.1
        with:
          api-key: ${{ secrets.MAESTRO_CLOUD_API_KEY }}
          app-file: bin/${{ steps.downloadfileandroid.outputs.filename }}
          workspace: maestro/
