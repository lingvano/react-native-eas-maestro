name: CI Actions
on:
  push:
    branches: [master, main]
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true
jobs:
  maestro-ios:
    name: Maestro IOS
    runs-on: ubuntu-latest
    steps:
      - name: 🏗 Checkout repository
        uses: actions/checkout@v2

      - name: 🏗 Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16
          cache: npm

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v7
        with:
          expo-version: 5.x
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: get latest build
        run: echo "BUILD_URL=$(node ./scripts/latestBuildIos.js)" >> $GITHUB_OUTPUT

      # - name: mock save url
      #   run: echo "BUILD_URL=$(echo 'https://expo.dev/artifacts/eas/cbzfHaWZCmBATr4nJRKMwW.tar.gz')" >> $GITHUB_ENV

      - name: download latest build
        uses: suisei-cn/actions-download-file@v1
        with:
          url: ${{ env.BUILD_URL }}
          target: bin/

      - name: unzip latest build
        run: |
          cd bin
          ls -a
          for f in *.tar.gz; do tar -xvf "$f"; done

      # - uses: mobile-dev-inc/action-maestro-cloud@v1.1.1
      #   with:
      #     api-key: ${{ secrets.MAESTRO_CLOUD_API_KEY }}
      #     app-file: bin/Lingvano.app
      #     workspace: maestro/
